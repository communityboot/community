<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>消息管理</title>
    <link rel="stylesheet" th:href="@{/webjars/layui/2.5.4/css/layui.css}" media="all">
    <script th:src="@{/webjars/jquery/3.4.1/jquery.min.js}"></script>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div th:replace="/commons/bar::topbar"></div>
    <div th:replace="/commons/bar::sidebar"></div>
    <div class="layui-body">
        <!-- 内容主体区域 -->
        <div>
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <blockquote class="layui-elem-quote">字典管理</blockquote>
                        <div class="layui-col-md12">
                            <div class="layui-card">
                                <div class="layui-card-body">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">字典名称</label>
                                        <div class="layui-input-inline">
                                            <input style="height: 32px; width: 110px" type="text" name="dictName"
                                                   lay-verify="required" placeholder="输入字典名称" autocomplete="off"
                                                   class="layui-input">
                                        </div>
                                        <label class="layui-form-label">字典代号</label>
                                        <div class="layui-input-inline">
                                            <input style="height: 32px; width: 110px" type="text" name="dictLabel"
                                                   lay-verify="required" placeholder="输入字典代号" autocomplete="off"
                                                   class="layui-input">
                                        </div>
                                        <button class="layui-btn layui-btn-sm layui-bg-blue "><i
                                                class="layui-icon layui-icon-search"></i>&nbsp;搜索
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="layui-bg-orange">
                </div>
            </div>
        </div>

        <table class="layui-hide" id="dictValue" lay-filter="dictValue"></table>
        <script type="text/html" id="toolbarDemo">
            <div class="layui-btn-container">
                <button class="layui-btn layui-btn-sm layui-bg-green" lay-event="addDict"><i
                        class="layui-icon layui-icon-add-1"></i>&nbsp;新增
                </button>
                <button class="layui-btn layui-btn-sm layui-bg-red" lay-event="delDict"><i
                        class="layui-icon layui-icon-delete"></i>&nbsp;删除
                </button>
                <button class="layui-btn layui-btn-sm layui-bg-orange" lay-event="modifyDict"><i
                        class="layui-icon layui-icon-edit"></i>&nbsp;修改
                </button>
            </div>
        </script>
    </div>
    <div id="edit" hidden="hidden">
        <form id="editForm" lay-filter="menuForm" class="layui-form model-form">
            <div class="layui-form-item">
                <label class="layui-form-label">字典显示的名字<span style="color: red;">*</span></label>
                <div class="layui-input-block">
                    <input id="dictKey" name="dictKey" placeholder="请输入字典显示的名" type="text" class="layui-input"/>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">字典的值<span style="color: red;">*</span></label>
                <div class="layui-input-block">
                    <input id="dictVal" name="dictVal" placeholder="请输入字典的值" type="text" class="layui-input"
                           lay-verify="required" required/>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">字典排序<span style="color: red;">*</span></label>
                <div class="layui-input-block">
                    <input id="sort" name="sort" placeholder="请输入字典排序" type="text" class="layui-input"
                           autocomplete="off" lay-verify="required" required/>
                </div>
            </div>
            <div class="layui-form-item" align="center">
                <button class="layui-btn " id="closeDialog">取消</button>
                <button class="layui-btn" lay-submit lay-filter="submitBtn">立即提交</button>

            </div>
        </form>
    </div>
    <div th:replace="/commons/bar::footbar"></div>
</div>
<script type="text/javascript" th:src="@{/webjars/layui/2.5.4/layui.js}"></script>
<script>

    //JavaScript代码区域
    layui.use('element', function () {
        var element = layui.element;
    });


</script>


<script th:inline="none">

    var Message_TypeMap = new Map();
    // 以 消息类型为例
    // 走字典接口查询相对应的键值
    $.ajax({
        type: "post",
        url: "/dv/getDictByCode?dicCode=Message_Type",
        success: function (data) {
            if (data.code === 200) {
                for(var i = 0 ; i < data.data.length;i++){
                    Message_TypeMap.set(data.data[i].dictKey,data.data[i].dictVal);
                }
                alert("更新成功");
            } else {
                alert("信息有误，请检查!");
            }
        }
    });

    layui.use('table', function () {
        var table = layui.table;
        var $ = layui.$;
        table.render({
            elem: '#dictValue'
            , url: '/m/getAllMessage'
            , toolbar: '#toolbarDemo'
            , title: '字典详情表'
            , cols: [[
                {type: 'checkbox', fixed: 'left'}
                , {field: 'id', title: 'ID'}
                , {field: 'msgType', title: '消息类型',templet: function(d) {
                        var temp = d.msgType;
                        return Message_TypeMap.get(''+temp+'');
                    }}
                , {field: 'msgStatus', title: '消息状态'}
                , {field: 'msgCreator', title: '消息创建者'}
                , {field: 'msgSender', title: '消息发送者'}
                , {field: 'msgReceiver', title: 'msgReceiver'}
                , {field: 'msgTitle', title: '消息标题'}
                , {field: 'msgContent', title: '消息内容'}
                , {field: 'msgSummary', title: '消息概要'}
                , {field: 'msgEffectTime', title: '生效时间'}
                , {field: 'msgExpireTime', title: '失效时间'}
                , {field: 'loginIp', title: '登录ip'}
                , {field: 'createDate', title: '创建时间'}
                , {field: 'lastModified', title: '更新时间'}
                , {field: 'memo', title: '备注'}
            ]]
            , page: true
        });


        //头工具栏事件
        table.on('toolbar(dictValue)', function (obj) {
            var $ = layui.jquery;
            var checkStatus = table.checkStatus(obj.config.id);
            switch (obj.event) {
                case 'addDict':
                    var data = checkStatus.data;
                    layer.open({
                        title: "字典信息修改",
                        type: 1,
                        skin: 'layui-layer-rim', //加上边框
                        area: ['700px', '480px'], //宽高
                        content: $("#edit")
                    });
                    break;
                case 'delDict':
                    var data = checkStatus.data;
                    var arr = [];
                    for (var i = 0; i < data.length; i++) {
                        arr.push(data[i].id);
                    }
                    layer.confirm('确定删除吗？', {
                        btn: ['取消', '确定'] //按钮
                    }, function () {
                        layer.closeAll();
                    }, function () {
                        $.ajax({
                            type: "post",
                            url: "/dv/delDictValBatch",
                            dataType: 'json',
                            data: {"ids": arr},
                            success: function (data) {
                                if (data.result === "success") {
                                    layer.msg("删除成功!");
                                    obj.del();
                                } else {
                                    layer.msg(data.msg);
                                    layer.close(index);
                                }
                            }
                        });
                    });
                    break;
                case 'modifyDict':
                    var data = checkStatus.data;
                    if (data.length === 1) {
                        var $ = layui.jquery, form = layui.form;
                        $.ajax({
                            type: "post",
                            url: "/dict/getDictInfo",
                            dataType: 'json',
                            data: "id=" + data[0].id,
                            success: function (data) {
                                if (data.result === "000") {
                                    $("#dictId").val(data.dict.id);
                                    $("#dictName").val(data.dict.dictName);
                                    $("#dictLabel").val(data.dict.dictLabel);
                                    $("#remark").val(data.dict.remark);
                                    form.render();
                                } else {
                                    layer.msg("信息有误，请检查!");
                                }
                            }
                        });
                        layer.open({
                            title: "字典信息修改",
                            type: 1,
                            skin: 'layui-layer-rim', //加上边框
                            area: ['700px', '480px'], //宽高
                            content: $("#edit")
                        });
                    } else if (data.length === 0) {
                        layer.msg("所选数量为0，请选择需要操作的数据");

                    } else {
                        layer.msg("所选数量超过1，只能对单条数据进行编辑！")
                    }
                    break;
                default:
                    break;
            }
        });
    });
</script>
<script>
    layui.use('form', function () {
        var form = layui.form;
        form.on('submit(submitBtn)', function (data) {
            $.ajax({
                type: "post",
                url: "/dv/updateDict",
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                data: JSON.stringify(data.field),
                success: function (data) {
                    console.log(JSON.stringify(data));
                    if (data.msg === "success") {
                        layer.msg("更新成功");
                        window.parent.location.reload();//修改成功后刷新父界面
                        layer.closeAll();
                    } else {
                        layer.msg("信息有误，请检查!");
                    }
                }
            });
            return false;
        });
    });
    $("#closeDialog").click(function () {
        $("#dictId").val("");
        $("#dictName").val("");
        $("#dictLabel").val("");
        layer.closeAll();
        return false;
    });
</script>
</body>
</html>